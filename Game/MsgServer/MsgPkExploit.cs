using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;

namespace TheChosenProject.Game.MsgServer
{
    public unsafe partial class MsgBuilder
    {
        public static unsafe ServerSockets.Packet PkExploitCreate(this ServerSockets.Packet stream, Client.GameClient user, byte Page)
        {
            stream.InitWriter();
            try
            {

                Role.Instance.Associate.Member[] Members = user.Player.Associate.GetPkExplorerRank();

                const int max = 10;
                int offset = Page * max;
                int count = Math.Min(max, Math.Max(0, Members.Length - offset));

                //   stream.Write(Extensions.Time32.Now.Value);
                //stream.Write((uint)0);
                stream.Write(1);//type?
                stream.Write(Members.Length);
                stream.Write((uint)count);
                var list = Members.Skip(Page * 10);
                foreach (var member in list.Take(count))
                {
                    stream.Write(member.Name, 16);
                    stream.Write((uint)member.KillsCount);
                    stream.Write((uint)member.Timer);
                    stream.Write(member.Map, 16);// Map Name
                    stream.ZeroFill(20);
                    stream.Write((uint)member.BattlePower);
                    //stream.Write((uint)0);
                }
            }
            catch (Exception e) { Console.WriteException(e); }


            stream.Finalize(GamePackets.PkExploit);
            return stream;
        }
    }

    public class MsgPkExploit
    {

        [PacketAttribute(GamePackets.PkExploit)]
        public unsafe static void HandlerPkExploit(Client.GameClient user, ServerSockets.Packet stream)
        {
            try
            {

                uint timer = stream.ReadUInt32();
                uint Typ = stream.ReadUInt32();
                byte Page = stream.ReadUInt8();
                //List<sbyte> vals = new List<sbyte>();
                //for (int l = 0; l < 70; l++)
                //    vals.Add(stream.ReadInt8());

                user.Send(stream.PkExploitCreate(user, Page));
            }
            catch (Exception e) { Console.WriteLine(e.ToString()); }
        }
    }
}
